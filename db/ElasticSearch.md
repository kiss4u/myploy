[TOC]



## 倒排索引

>

## ES分布式架构原理

>1、索引index划分为多个分片，分布在多台机器上，每台机器上都有其他分片的副本，其中主分片负则读写，副本分片只负责读
>
>2、集群中会选举出一个master负则维护索引，如果master宕机会从其他节点选举出新的，并调整主备分片的身份

## 读写原理

> 客户端连接任意节点，数据hash计算应该出目标存储节点，如果当前是协调节点，就把数据转发给目标节点写主分片，同步备份分片。

### 写数据

> 1、数据写入内存buff（不可被查询到），默认每秒钟refresh一次，将buff内数据写到os cache（可被查询到），后续再写到磁盘新的segment file
>
> 2、写translog日志文件（宕机恢复），每30分钟flush一次，将buff内数据写到os cache，继而写segment file，磁盘创建一个commit point标识已处理数据，新建translog文件
>
> 3、translog文件默认也是先写os cache，每5秒刷新写入文件，因此可能会丢失这几秒数据，可以设置每次操作即时存盘，但是影响性能
>
> 4、当segment file过多会执行merge操作，合并成一个大文件，merge时清理已标记删除的记录

### 删数据

>在磁盘del文件中，对数据标识已删除

### 查询

>客户端连接任意节点，document Id进行hash找到目标节点，如果当前是协调节点，就去目标节点请求数据，成功后返回给客户端

### 搜索

>客户端连接任意节点，如果当前是协调节点，对所有分片（主或副本任选）发起查询，返回doc Id汇总到协调节点，由协调节点进行合并、排序分页等操作，再根据id获取详细数据返回客户端

## 海量数据如何提高查询效率

>1、控制数据量小于等于内存大小，让file system cache内覆盖更多数据，查询优先走缓存
>
>2、ES里只存搜索用的关键字段，其他存在别的地方
>
>3、冷热分离，按规则划分多个index存储
>
>
>
>4、索引创建时，指定类型
>
>5、避免复杂查询
>
>6、数据预热

## 分页

>1、from、to
>
>2、scroll  每次用上次返回的scrollId进行查询，无法跳页
>
>3、searchAfter
>
>
>
>我们是按时间戳查询时间范围段，es里只存最近一个月数据





