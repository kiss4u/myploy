
[TOC]


### Quorum算法机制

> 一定时间范围内，大于(n / 2 + 1)认为成功


### 分布式存储如何保障数据安全

> 1、分片存储

> 2、多副本冗余

> 4、宕机感知

> 5、自动副本迁移

> 6、多余副本删除

### 分布式事务

#### 两阶段提交（XA）

>  1、事务管理器（协调者）负责询问所有本地资源管理器（数据库），先执行pre commit以及能否执行commit，全部回复ok进入第二阶段
>  2、协调者向通知所有节点进行commit，如果有一个否定则向前执行回滚
>  JTA实现，依赖数据库层面，不适合高并发场景

#### TCC

> 1、try预扣
> 2、commit 确定提交
> 3、cancel 回滚恢复

#### 本地消息表

> 1、A系统执行一个事务操作后，在本地消息表保存一条数据
> 2、A系统发送请求到mq
> 3、B系统消费mq，往自己本地消息表插一条数据，同时执行业务操作，如果发现这条消息已经被处理过，则抛弃
> 4、B系统执行结束后，修改本地及A系统本地消息表状态
> 5、A系统扫描本地消息表状态，如果未完成则重新执行步骤2

#### 可靠消息最终一致性

> 1、A系统将prepared消息发送到mq，如果发送失败就取消执行
> 2、A发送prepared成功，执行本地事务，执行成功通知mq将prepared消息状态变更到确认使B系统可消费，执行失败通知mq回滚prepared消息
> 3、mq轮询所有未确认状态的prepared消息，回调A系统接口检查A本地执行状态，执行成功未收到确认消息还是执行失败
> 4、B系统消费mq，执行失败需重试，要保证幂等性（zookeeper创建节点）

#### 最大努力通知

>  单独一个服务实现最大努力通知服务，一直尝试通知下游服务执行直到成功











